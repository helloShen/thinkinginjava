---
layout: post
num: 6
title: Exercise 6
chapter: Chapter 17
description: >
  (2) Note that List has additional "optional" operations that are not included in Collection. Write a version of Unsupported.java that tests these additional optional operations.
---



#### Exercise6.java


这题不难，但对理清Collection接口思路很重要。要实现Collection接口，当然不需要全都亲力亲为，继承AbstractCollection接口就行。接下来自己要做的事就少很多。关键要搞清楚Collection接口的层次。


1. AbstractCollection实现的是最简单的unmodifiable collection。因为还不知道数据实体，AbstractCollection实现的所有其他方法，基于两个重要方法iterator()和size()。继承AbstractCollection首先要补写iterator()和size()方法。其中iterator()方法返回一个迭代器。所以还需要写一个内部迭代器类。
2. 如果想获得modifiable collection。在原先unmodifiable collection的基础上还要实现Iterator#remove()方法，以及add(),addAll()等增删操作的方法。
3. 最后一类是这一题要求的的Collection接口没有定义的，但是在List接口里支持的方法。比如get(), indexOf(), lastIndexOf()。因为Set是自己管理元素的顺序，所以不支持随机访问方法。



```java


package com.ciaoshen.thinkinjava.newchapter17;
import java.util.*;

public class Exercise6 {
    public static class Unsupported<E> extends AbstractCollection<E> {
        private List<E> list = new ArrayList<E>();

        // unmodifiable collection 只需要额外实现iterator()和size()方法。当然equals()和hashCode()最好也实现一下。
        public int size() {
            return list.size();
        }
        public Iterator<E> iterator() {
            return list.iterator();
        }

        // modifiable collection 还要补上Iterator#remove()和add()以及addAll()方法
        public boolean add(E item) {
            return list.add(item);
        }
        public boolean addAll(Collection<? extends E> c) {
            return list.addAll(c);
        }

        // 以下是Collection接口不支持，但List接口却支持的方法。
        public E get(int index) {
            return list.get(index);
        }
        public int indexOf(Object o) {
            return list.indexOf(o);
        }
        public int lastIndexOf(Object o) {
            return list.lastIndexOf(o);
        }
        public ListIterator<E> listIterator() {
            return list.listIterator();
        }
        public List<E> subList(int fromIndex, int toIndex) {
            return list.subList(fromIndex,toIndex);
        }
    }
    public static void main(String[] args) {
        List<Map.Entry<String,String>> countriesList = Countries.getSortedCountries();
        System.out.println(countriesList.size());
        System.out.println(countriesList);
        countriesList.addAll(countriesList);
        System.out.println(countriesList.get(Countries.countriesSize()*2-1));
        System.out.println(countriesList.indexOf(new Countries.CountryPair("ALGERIA","Algiers")));
    }
}


```





#### Countries.java

用来自动生成国家首都信息列表的类。把之前的享元Map框架和根据享元生成实际副本的代码组合在了一起。



```java


package com.ciaoshen.thinkinjava.newchapter17;
import java.util.*;
import java.util.regex.*;

/**
 * 用来自动生成包含国家首都信息的List,Set或Map。
 * 前半部分是包含所有国家首都信息的享元Map。
 * 后半部分是把享元index信息转化成实际副本的脚本。
 */
public class Countries extends AbstractMap<String,String> {
    public static int countriesSize() {
        return DATA.length;
    }
    public static final String[][] DATA = {
        // Africa
        {"ALGERIA","Algiers"}, {"ANGOLA","Luanda"},
        {"BENIN","Porto-Novo"}, {"BOTSWANA","Gaberone"},
        {"BURKINA FASO","Ouagadougou"},
        {"BURUNDI","Bujumbura"},
        {"CAMEROON","Yaounde"}, {"CAPE VERDE","Praia"},
        {"CENTRAL AFRICAN REPUBLIC","Bangui"},
        {"CHAD","N’djamena"}, {"COMOROS","Moroni"},
        {"CONGO","Brazzaville"}, {"DJIBOUTI","Dijibouti"},
        {"EGYPT","Cairo"}, {"EQUATORIAL GUINEA","Malabo"},
        {"ERITREA","Asmara"}, {"ETHIOPIA","Addis Ababa"},
        {"GABON","Libreville"}, {"THE GAMBIA","Banjul"},
        {"GHANA","Accra"}, {"GUINEA","Conakry"},
        {"BISSAU","Bissau"},
        {"COTE D’IVOIR (IVORY COAST)","Yamoussoukro"},
        {"KENYA","Nairobi"}, {"LESOTHO","Maseru"},
        {"LIBERIA","Monrovia"}, {"LIBYA","Tripoli"},
        {"MADAGASCAR","Antananarivo"}, {"MALAWI","Lilongwe"},
        {"MALI","Bamako"}, {"MAURITANIA","Nouakchott"},
        {"MAURITIUS","Port Louis"}, {"MOROCCO","Rabat"},
        {"MOZAMBIQUE","Maputo"}, {"NAMIBIA","Windhoek"},
        {"NIGER","Niamey"}, {"NIGERIA","Abuja"},
        {"RWANDA","Kigali"},
        {"SAO TOME E PRINCIPE","Sao Tome"},
        {"SENEGAL","Dakar"}, {"SEYCHELLES","Victoria"},
        {"SIERRA LEONE","Freetown"}, {"SOMALIA","Mogadishu"},
        {"SOUTH AFRICA","Pretoria/Cape Town"},
        {"SUDAN","Khartoum"},
        {"SWAZILAND","Mbabane"}, {"TANZANIA","Dodoma"},
        {"TOGO","Lome"}, {"TUNISIA","Tunis"},
        {"UGANDA","Kampala"},
        {"DEMOCRATIC REPUBLIC OF THE CONGO (ZAIRE)",
        "Kinshasa"},
        {"ZAMBIA","Lusaka"}, {"ZIMBABWE","Harare"},
        // Asia
        {"AFGHANISTAN","Kabul"}, {"BAHRAIN","Manama"},
        {"BANGLADESH","Dhaka"}, {"BHUTAN","Thimphu"},
        {"BRUNEI","Bandar Seri Begawan"},
        {"CAMBODIA","Phnom Penh"},
        {"CHINA","Beijing"}, {"CYPRUS","Nicosia"},
        {"INDIA","New Delhi"}, {"INDONESIA","Jakarta"},
        {"IRAN","Tehran"}, {"IRAQ","Baghdad"},
        {"ISRAEL","Jerusalem"}, {"JAPAN","Tokyo"},
        {"JORDAN","Amman"}, {"KUWAIT","Kuwait City"},
        {"LAOS","Vientiane"}, {"LEBANON","Beirut"},
        {"MALAYSIA","Kuala Lumpur"}, {"THE MALDIVES","Male"},
        {"MONGOLIA","Ulan Bator"},
        {"MYANMAR (BURMA)","Rangoon"},
        {"NEPAL","Katmandu"}, {"NORTH KOREA","P’yongyang"},
        {"OMAN","Muscat"}, {"PAKISTAN","Islamabad"},
        {"PHILIPPINES","Manila"}, {"QATAR","Doha"},
        {"SAUDI ARABIA","Riyadh"}, {"SINGAPORE","Singapore"},
        {"SOUTH KOREA","Seoul"}, {"SRI LANKA","Colombo"},
        {"SYRIA","Damascus"},
        {"TAIWAN (REPUBLIC OF CHINA)","Taipei"},
        {"THAILAND","Bangkok"}, {"TURKEY","Ankara"},
        {"UNITED ARAB EMIRATES","Abu Dhabi"},
        {"VIETNAM","Hanoi"}, {"YEMEN","Sana’a"},
        // Australia and Oceania
        {"AUSTRALIA","Canberra"}, {"FIJI","Suva"},
        {"KIRIBATI","Bairiki"},
        {"MARSHALL ISLANDS","Dalap-Uliga-Darrit"},
        {"MICRONESIA","Palikir"}, {"NAURU","Yaren"},
        {"NEW ZEALAND","Wellington"}, {"PALAU","Koror"},
        {"PAPUA NEW GUINEA","Port Moresby"},
        {"SOLOMON ISLANDS","Honaira"}, {"TONGA","Nuku’alofa"},
        {"TUVALU","Fongafale"}, {"VANUATU","< Port-Vila"},
        {"WESTERN SAMOA","Apia"},
        // Eastern Europe and former USSR
        {"ARMENIA","Yerevan"}, {"AZERBAIJAN","Baku"},
        {"BELARUS (BYELORUSSIA)","Minsk"},
        {"BULGARIA","Sofia"}, {"GEORGIA","Tbilisi"},
        {"KAZAKSTAN","Almaty"}, {"KYRGYZSTAN","Alma-Ata"},
        {"MOLDOVA","Chisinau"}, {"RUSSIA","Moscow"},
        {"TAJIKISTAN","Dushanbe"}, {"TURKMENISTAN","Ashkabad"},
        {"UKRAINE","Kyiv"}, {"UZBEKISTAN","Tashkent"},
        // Europe
        {"ALBANIA","Tirana"}, {"ANDORRA","Andorra la Vella"},
        {"AUSTRIA","Vienna"}, {"BELGIUM","Brussels"},
        {"BOSNIA","-"}, {"HERZEGOVINA","Sarajevo"},
        {"CROATIA","Zagreb"}, {"CZECH REPUBLIC","Prague"},
        {"DENMARK","Copenhagen"}, {"ESTONIA","Tallinn"},
        {"FINLAND","Helsinki"}, {"FRANCE","Paris"},
        {"GERMANY","Berlin"}, {"GREECE","Athens"},
        {"HUNGARY","Budapest"}, {"ICELAND","Reykjavik"},
        {"IRELAND","Dublin"}, {"ITALY","Rome"},
        {"LATVIA","Riga"}, {"LIECHTENSTEIN","Vaduz"},
        {"LITHUANIA","Vilnius"}, {"LUXEMBOURG","Luxembourg"},
        {"MACEDONIA","Skopje"}, {"MALTA","Valletta"},
        {"MONACO","Monaco"}, {"MONTENEGRO","Podgorica"},
        {"THE NETHERLANDS","Amsterdam"}, {"NORWAY","Oslo"},
        {"POLAND","Warsaw"}, {"PORTUGAL","Lisbon"},
        {"ROMANIA","Bucharest"}, {"SAN MARINO","San Marino"},
        {"SERBIA","Belgrade"}, {"SLOVAKIA","Bratislava"},
        {"SLOVENIA","Ljuijana"}, {"SPAIN","Madrid"},
        {"SWEDEN","Stockholm"}, {"SWITZERLAND","Berne"},
        {"UNITED KINGDOM","London"}, {"VATICAN CITY","---"},
        // North and Central America
        {"ANTIGUA AND BARBUDA","Saint John’s"},
        {"BAHAMAS","Nassau"},
        {"BARBADOS","Bridgetown"}, {"BELIZE","Belmopan"},
        {"CANADA","Ottawa"}, {"COSTA RICA","San Jose"},
        {"CUBA","Havana"}, {"DOMINICA","Roseau"},
        {"DOMINICAN REPUBLIC","Santo Domingo"},
        {"EL SALVADOR","San Salvador"},
        {"GRENADA","Saint George’s"},
        {"GUATEMALA","Guatemala City"},
        {"HAITI","Port-au-Prince"},
        {"HONDURAS","Tegucigalpa"}, {"JAMAICA","Kingston"},
        {"MEXICO","Mexico City"}, {"NICARAGUA","Managua"},
        {"PANAMA","Panama City"}, {"ST. KITTS","-"},
        {"NEVIS","Basseterre"}, {"ST. LUCIA","Castries"},
        {"ST. VINCENT AND THE GRENADINES","Kingstown"},
        {"UNITED STATES OF AMERICA","Washington, D.C."},
        // South America
        {"ARGENTINA","Buenos Aires"},
        {"BOLIVIA","Sucre (legal)/La Paz(administrative)"},
        {"BRAZIL","Brasilia"}, {"CHILE","Santiago"},
        {"COLOMBIA","Bogota"}, {"ECUADOR","Quito"},
        {"GUYANA","Georgetown"}, {"PARAGUAY","Asuncion"},
        {"PERU","Lima"}, {"SURINAME","Paramaribo"},
        {"TRINIDAD AND TOBAGO","Port of Spain"},
        {"URUGUAY","Montevideo"}, {"VENEZUELA","Caracas"},
    };
    private int countriesSize;
    public Countries() {
        this(DATA.length);
    }
    public Countries(int num) {
        countriesSize = num;
        if (countriesSize < 0) {
            countriesSize = 0;
        }
        if (countriesSize > DATA.length) {
            countriesSize = DATA.length;
        }
    }
    public int size() {
        return countriesSize;
    }
    public static class Country implements Map.Entry<String,String> {
        private int index=0;
        public Country(int num) {
            index = num;
        }
        public String getKey() {
            return DATA[index][0];
        }
        public String getValue() {
            return DATA[index][1];
        }
        public String setValue(String str) {
            throw new UnsupportedOperationException();
        }
        public boolean equals(Object o) {
            if (o == null || ! (o instanceof Country)) {
                return false;
            }
            return DATA[index][0].equals((Country)o);
        }
        public int hashCode() {
            return DATA[index][0].hashCode();
        }
    }
    public class CountrySet extends AbstractSet<Map.Entry<String,String>> {
        private int index = 0;
        private Country viewWindow = new Country(-1);
        public Iterator<Map.Entry<String,String>> iterator() {
            return new Iterator<Map.Entry<String,String>>() {
                public boolean hasNext() {
                    return index < countriesSize;
                }
                public Map.Entry<String,String> next() {
                    viewWindow.index++;
                    index++;
                    return viewWindow;
                }
                public void remove() {
                    throw new UnsupportedOperationException();
                }
            };
        }
        public int size() {
            return countriesSize;
        }
    }
    public Set<Map.Entry<String,String>> entrySet() {
        return new CountrySet();
    }

    /**
     * 完整健壮的方法从享元中提取副本
     */
    // read only country info container
    public static class CountryPair implements Map.Entry<String,String> {
        private final String name;
        private final String capital;
        public CountryPair(String key, String value) {
            name = key;
            capital = value;
        }
        public String getKey() {
            return name;
        }
        public String getValue() {
            return capital;
        }
        public String setValue(String vaule) {  // read only, so ignore
            throw new UnsupportedOperationException();
        }
        public boolean equals(Object o) {
            if (o == null || !(o instanceof CountryPair)) {
                return false;
            }
            return name.equals(((CountryPair)o).getKey());
        }
        public int hashCode() {
            return name.hashCode();
        }
        public String toString() {
            return "(" + name + " = " + capital + ")";
        }
    }
    public static List<Map.Entry<String,String>> getSortedCountries(int size) {
        List<Map.Entry<String,String>> countriesList = new ArrayList<Map.Entry<String,String>>();
        for (Map.Entry<String,String> country : new FlyWeightMap(size).entrySet()) {
            countriesList.add(new CountryPair(country.getKey(), country.getValue()));
        }
        Collections.sort(countriesList, new Comparator<Map.Entry<String,String>>() {
            public int compare(Map.Entry<String,String> country1, Map.Entry<String,String> country2) {
                return String.CASE_INSENSITIVE_ORDER.compare(country1.getKey(),country2.getKey());
            }
        });
        return countriesList;
    }
    public static List<Map.Entry<String,String>> getSortedCountries() {
        int countriesSize = FlyWeightMap.dataSize();
        return getSortedCountries(countriesSize);
    }
    public static List<Map.Entry<String,String>> getCountriesByRegex(String regex) {
        List<Map.Entry<String,String>> resultList = new ArrayList<Map.Entry<String,String>>();
        Matcher m = Pattern.compile(regex).matcher("");
        for (Map.Entry<String,String> country : getSortedCountries()) {
            m = m.reset(country.getKey());
            if (m.find()) {
                resultList.add(country);
            }
        }
        return resultList;
    }
    public static <T> Set<T> fillSetByList(List<T> list) {
        Set<T> set = new HashSet<T>();
        set.addAll(list);
        return set;
    }
    public static <K,V> Map<K,V> fillMapByList(List<Map.Entry<K,V>> list) {
        if (list == null || list.isEmpty()) {
            return null;
        }
        Map<K,V> map = new HashMap<K,V>();
        for (Map.Entry<K,V> ele : list) {
            map.put(ele.getKey(),ele.getValue());
        }
        return map;
    }
}


```



